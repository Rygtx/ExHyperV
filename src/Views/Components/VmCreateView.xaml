<UserControl
    x:Class="ExHyperV.Views.Components.VmCreateView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:properties="clr-namespace:ExHyperV.Properties"
    xmlns:converters="clr-namespace:ExHyperV.Converters"
    xmlns:sys="clr-namespace:System;assembly=mscorlib">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVis" />
        <converters:EqualityConverter x:Key="EqualityConverter" />
        <converters:EqualityToVisibilityConverter x:Key="EqualityToVis" />
    </UserControl.Resources>

    <Grid Background="{ui:ThemeResource ApplicationBackgroundBrush}">
        <!-- 内容区域 -->
        <ScrollViewer Padding="24,24,24,24" VerticalScrollBarVisibility="Auto">
            <StackPanel>

                <!-- 1. 标题栏 -->
                <Grid Margin="0,0,0,24">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="新建虚拟机" 
                               FontSize="24" 
                               Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"
                               VerticalAlignment="Center"/>

                    <ui:Button Grid.Column="1" Appearance="Transparent" Padding="8" Command="{Binding CancelCreateCommand}">
                        <ui:SymbolIcon Symbol="ArrowLeft24" FontSize="18"/>
                    </ui:Button>
                </Grid>

                <!-- === 常规 === -->
                <TextBlock Text="常规" FontSize="16" FontWeight="Medium" Margin="0,0,0,12"
                           Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                <ui:CardControl Header="名称" Icon="{ui:SymbolIcon Symbol=Edit24}" Margin="0,0,0,8" HorizontalContentAlignment="Stretch">
                    <!-- 添加 Width="450" 以防止收缩，并保持与下方“配置文件位置”对齐 -->
                    <ui:TextBox Text="{Binding NewVmName, UpdateSourceTrigger=PropertyChanged}" 
                PlaceholderText="例如: Windows_Server_2025"
                Width="210"
                HorizontalAlignment="Right"/>

                </ui:CardControl>

                <ui:CardControl Header="配置文件位置" Icon="{ui:SymbolIcon Symbol=FolderOpen24}" Margin="0,0,0,8" HorizontalContentAlignment="Stretch">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ui:TextBox Text="{Binding NewVmStoragePath}" Width="450"/>
                        <ui:Button Grid.Column="1" Content="浏览" Margin="8,0,0,0" Command="{Binding BrowseNewVmPathCommand}"/>
                    </Grid>
                </ui:CardControl>

                <ui:CardControl Header="虚拟机版本" Icon="{ui:SymbolIcon Symbol=History24}" Margin="0,0,0,8">
                    <ComboBox ItemsSource="{Binding SupportedVersions}" SelectedItem="{Binding SelectedVersion}" Width="100"/>
                </ui:CardControl>

                <ui:CardControl Header="代际" Margin="0,0,0,24">
                    <ui:CardControl.Icon>
                        <ui:FontIcon Glyph="&#xE8C8;" FontSize="20" FontFamily="{DynamicResource SegoeFluentIcons}" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                    </ui:CardControl.Icon>
                    <StackPanel Orientation="Horizontal">
                        <RadioButton Content="第 1 代 ( BIOS + MBR )" IsChecked="{Binding NewVmGeneration, Converter={StaticResource EqualityConverter}, ConverterParameter=1}" Margin="0,0,24,0"/>
                        <RadioButton Content="第 2 代 ( UEFI + GPT )" IsChecked="{Binding NewVmGeneration, Converter={StaticResource EqualityConverter}, ConverterParameter=2}"/>
                    </StackPanel>
                </ui:CardControl>

                <!-- === 计算资源 === -->
                <TextBlock Text="计算资源" FontSize="16" FontWeight="Medium" Margin="0,0,0,12" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                <ui:CardControl Header="处理器核心数" Margin="0,0,0,8">
                    <ui:CardControl.Icon>
                        <ui:FontIcon Glyph="&#xE950;" FontSize="20" FontFamily="{DynamicResource SegoeFluentIcons}" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                    </ui:CardControl.Icon>
                    <StackPanel Orientation="Horizontal">
                        <ComboBox IsEditable="True" Text="{Binding NewVmProcessorCount, UpdateSourceTrigger=PropertyChanged}" Width="85">
                            <sys:String>1</sys:String>
                            <sys:String>2</sys:String>
                            <sys:String>4</sys:String>
                            <sys:String>8</sys:String>
                            <sys:String>16</sys:String>
                            <sys:String>32</sys:String>
                            <sys:String>64</sys:String>
                        </ComboBox>
                        <TextBlock Text="核心" VerticalAlignment="Center" Margin="12,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                </ui:CardControl>

                <ui:CardControl Header="启动内存" Margin="0,0,0,8">
                    <ui:CardControl.Icon>
                        <ui:FontIcon Glyph="&#xEEA0;" FontSize="22" FontFamily="{DynamicResource SegoeFluentIcons}" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                    </ui:CardControl.Icon>
                    <StackPanel Orientation="Horizontal">
                        <ComboBox IsEditable="True" Text="{Binding NewVmMemoryMb, UpdateSourceTrigger=PropertyChanged}" Width="105">
                            <sys:String>1024</sys:String>
                            <sys:String>2048</sys:String>
                            <sys:String>4096</sys:String>
                            <sys:String>8192</sys:String>
                            <sys:String>16384</sys:String>
                            <sys:String>32768</sys:String>
                        </ComboBox>
                        <TextBlock Text="MB" VerticalAlignment="Center" Margin="12,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                </ui:CardControl>

                <ui:CardControl Header="动态内存" Icon="{ui:SymbolIcon Symbol=CheckmarkCircle24}" Margin="0,0,0,8">
                    <ui:ToggleSwitch IsChecked="{Binding NewVmDynamicMemory}"/>
                </ui:CardControl>

                <!-- 安全特性 (仅第2代可用) -->
                <ui:CardControl Header="安全特性" Icon="{ui:SymbolIcon Symbol=ShieldCheckmark24}" Margin="0,0,0,8"
                                IsEnabled="{Binding NewVmGeneration, Converter={StaticResource EqualityConverter}, ConverterParameter=2}">
                    <StackPanel Orientation="Horizontal">
                        <CheckBox Content="启用安全启动" IsChecked="{Binding NewVmEnableSecureBoot}" Margin="0,0,24,0"/>
                        <CheckBox Content="启用 TPM" IsChecked="{Binding NewVmEnableTpm}"/>
                    </StackPanel>
                </ui:CardControl>

                <ui:CardControl Header="机密计算" 
                Icon="{ui:SymbolIcon Symbol=ShieldLock24}" 
                Margin="0,0,0,24"
                IsEnabled="{Binding CanEnableIsolation}">

                    <StackPanel Orientation="Horizontal">
                        <ComboBox ItemsSource="{Binding SupportedIsolationTypes}" 
                  SelectedItem="{Binding NewVmIsolationType}" 
                  Width="200"/>

                        <!-- 修复点：只有当 IsIsolationSupported 等于 False 时，才显示这个警告文本 -->
                        <TextBlock Text="当前宿主机不支持机密计算" 
                   VerticalAlignment="Center" Margin="12,0,0,0"
                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                   Visibility="{Binding IsIsolationSupported, Converter={StaticResource EqualityToVis}, ConverterParameter=False}"/>
                    </StackPanel>
                </ui:CardControl>
                
                <!-- === 存储资源 === -->
                <TextBlock Text="存储资源" FontSize="16" FontWeight="Medium" Margin="0,12,0,12" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                <Border Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}" 
                        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}" 
                        BorderThickness="1" CornerRadius="8" Padding="20" Margin="0,0,0,16">
                    <StackPanel>
                        <!-- 模式切换 -->
                        <Grid Margin="0,0,0,20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ui:SymbolIcon Symbol="Storage24" Margin="0,0,12,0" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="虚拟硬盘" FontSize="16" VerticalAlignment="Center" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                                <RadioButton Content="新建磁盘" IsChecked="{Binding NewVmDiskMode, Converter={StaticResource EqualityConverter}, ConverterParameter=0}" Margin="0,0,16,0"/>
                                <RadioButton Content="现有磁盘" IsChecked="{Binding NewVmDiskMode, Converter={StaticResource EqualityConverter}, ConverterParameter=1}" Margin="0,0,16,0"/>
                                <RadioButton Content="稍后附加" IsChecked="{Binding NewVmDiskMode, Converter={StaticResource EqualityConverter}, ConverterParameter=2}"/>
                            </StackPanel>
                        </Grid>

                        <!-- 模式0：新建磁盘 (容量与路径同行) -->
                        <Grid Visibility="{Binding NewVmDiskMode, Converter={StaticResource EqualityToVis}, ConverterParameter=0}" Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="160"/>
                                <ColumnDefinition Width="24"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="容量 (GB)" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,8"/>
                                <ComboBox IsEditable="True" Text="{Binding NewVmDiskSizeGb, UpdateSourceTrigger=PropertyChanged}" HorizontalAlignment="Stretch">
                                    <sys:String>60</sys:String>
                                    <sys:String>127</sys:String>
                                    <sys:String>256</sys:String>
                                    <sys:String>512</sys:String>
                                </ComboBox>
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="保存位置" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,8"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ui:TextBox Text="{Binding NewVmNewDiskPath}" PlaceholderText="选择新 .vhdx 文件的存放位置"/>
                                    <ui:Button Grid.Column="1" Content="浏览" Margin="8,0,0,0" Width="80" Command="{Binding BrowseNewDiskLocationCommand}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>

                        <!-- 模式1：现有磁盘 -->
                        <StackPanel Visibility="{Binding NewVmDiskMode, Converter={StaticResource EqualityToVis}, ConverterParameter=1}" Margin="0,10,0,0">
                            <TextBlock Text="现有磁盘路径" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,8"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ui:TextBox Text="{Binding NewVmExistingDiskPath}" PlaceholderText="选择 .vhdx 或 .avhdx 文件"/>
                                <ui:Button Grid.Column="1" Content="浏览" Margin="8,0,0,0" Width="80" Command="{Binding BrowseExistingDiskCommand}"/>
                            </Grid>
                        </StackPanel>

                        <!-- 模式2：稍后附加 -->
                        <TextBlock Text="虚拟机将在没有虚拟硬盘的情况下创建。您可以稍后手动添加。" 
                                   Visibility="{Binding NewVmDiskMode, Converter={StaticResource EqualityToVis}, ConverterParameter=2}"
                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" FontSize="13" Margin="0,10,0,0"/>
                    </StackPanel>
                </Border>

                <!-- === 安装介质 === -->
                <Border Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}" 
                        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}" 
                        BorderThickness="1" CornerRadius="8" Padding="20" Margin="0,0,0,24">
                    <StackPanel>
                        <Grid Margin="0,0,0,16">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ui:SymbolIcon Symbol="FolderZip24" Margin="0,0,12,0" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="安装介质" FontSize="16" VerticalAlignment="Center" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                            </StackPanel>
                        </Grid>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <ui:TextBox Text="{Binding NewVmIsoPath}" PlaceholderText="选择操作系统安装 ISO 镜像 (可选)"/>
                            <ui:Button Grid.Column="1" Content="浏览" Margin="8,0,0,0" Width="80" Command="{Binding BrowseIsoImageCommand}"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- === 网络资源 === -->
                <TextBlock Text="网络资源" FontSize="16" FontWeight="Medium" Margin="0,0,0,12" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                <ui:CardControl Header="虚拟交换机" Margin="0,0,0,24" HorizontalContentAlignment="Stretch">
                    <ui:CardControl.Icon>
                        <ui:FontIcon Glyph="&#xE774;" FontSize="20" FontFamily="{DynamicResource SegoeFluentIcons}" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                    </ui:CardControl.Icon>
                    <ComboBox ItemsSource="{Binding AvailableSwitchNames}" SelectedItem="{Binding NewVmSelectedSwitch}"/>
                </ui:CardControl>

                <!-- 3. 操作栏 -->
                <Border Background="Transparent" BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0" Padding="0,24,0,0">
                    <Grid>
                        <CheckBox Content="创建后启动" IsChecked="{Binding StartVmAfterCreation}" VerticalAlignment="Center"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <ui:Button Content="创建虚拟机" Appearance="Primary" Width="150" Icon="{ui:SymbolIcon Symbol=Add24}" Command="{Binding ConfirmCreateCommand}"/>
                        </StackPanel>
                    </Grid>
                </Border>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>