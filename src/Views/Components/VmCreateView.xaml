<UserControl
    x:Class="ExHyperV.Views.Components.VmCreateView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:properties="clr-namespace:ExHyperV.Properties"
    xmlns:converters="clr-namespace:ExHyperV.Converters"
    xmlns:sys="clr-namespace:System;assembly=mscorlib">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVis" />
        <converters:EqualityConverter x:Key="EqualityConverter" />
        <converters:EqualityToVisibilityConverter x:Key="EqualityToVis" />
    </UserControl.Resources>

    <Grid Background="{ui:ThemeResource ApplicationBackgroundBrush}">
        <!-- 内容区域 -->
        <ScrollViewer Padding="24,24,24,24" VerticalScrollBarVisibility="Auto">
            <StackPanel>

                <!-- 1. 标题 -->
                <TextBlock Text="新建虚拟机" 
                           FontSize="24" 
                           Margin="0,0,0,24"
                           Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                <!-- 常规 -->
                <TextBlock Text="常规" FontSize="16" FontWeight="Medium" Margin="0,0,0,12"
                           Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                <ui:CardControl Header="名称" Icon="{ui:SymbolIcon Symbol=Edit24}" Margin="0,0,0,8" HorizontalContentAlignment="Stretch">
                    <ui:TextBox Text="{Binding NewVmName, UpdateSourceTrigger=PropertyChanged}" PlaceholderText="例如: Windows_Server_2025_Test"/>
                </ui:CardControl>

                <ui:CardControl Header="配置文件位置" Icon="{ui:SymbolIcon Symbol=FolderOpen24}" Margin="0,0,0,8" HorizontalContentAlignment="Stretch">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ui:TextBox Text="{Binding NewVmStoragePath}" Width="450"/>
                        <ui:Button Grid.Column="1" Content="浏览" Margin="8,0,0,0" Command="{Binding BrowseNewVmPathCommand}"/>
                    </Grid>
                </ui:CardControl>

                <ui:CardControl Header="虚拟机版本" Icon="{ui:SymbolIcon Symbol=History24}" Margin="0,0,0,8">
                    <ComboBox ItemsSource="{Binding SupportedVersions}" SelectedItem="{Binding SelectedVersion}" Width="100"/>
                </ui:CardControl>

                <ui:CardControl Header="代际" Margin="0,0,0,24">
                    <ui:CardControl.Icon>
                        <ui:FontIcon Glyph="&#xE8C8;" FontSize="20" FontFamily="{DynamicResource SegoeFluentIcons}" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                    </ui:CardControl.Icon>
                    <StackPanel Orientation="Horizontal">
                        <RadioButton Content="第 1 代 ( BIOS + MBR )" IsChecked="{Binding NewVmGeneration, Converter={StaticResource EqualityConverter}, ConverterParameter=1}" Margin="0,0,24,0"/>
                        <RadioButton Content="第 2 代 ( UEFI + GPT )" IsChecked="{Binding NewVmGeneration, Converter={StaticResource EqualityConverter}, ConverterParameter=2}"/>
                    </StackPanel>
                </ui:CardControl>

                <!-- === 计算资源 === -->
                <TextBlock Text="计算资源" FontSize="16" FontWeight="Medium" Margin="0,0,0,12" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                <ui:CardControl Header="处理器核心数" Margin="0,0,0,8">
                    <ui:CardControl.Icon>
                        <ui:FontIcon Glyph="&#xE950;" FontSize="20" FontFamily="{DynamicResource SegoeFluentIcons}" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                    </ui:CardControl.Icon>
                    <StackPanel Orientation="Horizontal">
                        <ComboBox IsEditable="True" Text="{Binding NewVmProcessorCount, UpdateSourceTrigger=PropertyChanged}" Width="85">
                            <sys:String>1</sys:String>
                            <sys:String>2</sys:String>
                            <sys:String>4</sys:String>
                            <sys:String>8</sys:String>
                            <sys:String>16</sys:String>
                            <sys:String>32</sys:String>
                            <sys:String>64</sys:String>
                        </ComboBox>
                        <TextBlock Text="核心" VerticalAlignment="Center" Margin="12,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                </ui:CardControl>

                <ui:CardControl Header="启动内存" Margin="0,0,0,8">
                    <ui:CardControl.Icon>
                        <ui:FontIcon Glyph="&#xEEA0;" FontSize="22" FontFamily="{DynamicResource SegoeFluentIcons}" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                    </ui:CardControl.Icon>
                    <StackPanel Orientation="Horizontal">
                        <ComboBox IsEditable="True" Text="{Binding NewVmMemoryMb, UpdateSourceTrigger=PropertyChanged}" Width="105">
                            <sys:String>1024</sys:String>
                            <sys:String>2048</sys:String>
                            <sys:String>4096</sys:String>
                            <sys:String>8192</sys:String>
                            <sys:String>16384</sys:String>
                            <sys:String>32768</sys:String>
                        </ComboBox>
                        <TextBlock Text="MB" VerticalAlignment="Center" Margin="12,0,0,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                </ui:CardControl>

                <ui:CardControl Header="动态内存" Icon="{ui:SymbolIcon Symbol=CheckmarkCircle24}" Margin="0,0,0,8">
                    <ui:ToggleSwitch IsChecked="{Binding NewVmDynamicMemory}"/>
                </ui:CardControl>

                <ui:CardControl Header="机密计算" Icon="{ui:SymbolIcon Symbol=ShieldLock24}" Margin="0,0,0,24"
                                IsEnabled="{Binding NewVmGeneration, Converter={StaticResource EqualityConverter}, ConverterParameter=2}">
                    <StackPanel Orientation="Horizontal">
                        <ComboBox SelectedValue="{Binding NewVmIsolationType}" Width="200">
                            <sys:String>Disabled</sys:String>
                            <sys:String>TrustedLaunch</sys:String>
                            <sys:String>VBS</sys:String>
                            <sys:String>SNP (AMD SEV-SNP)</sys:String>
                            <sys:String>TDX (Intel Trust Domain)</sys:String>
                        </ComboBox>
                    </StackPanel>
                </ui:CardControl>

                <!-- === 存储资源 === -->
                <TextBlock Text="存储资源" FontSize="16" FontWeight="Medium" Margin="0,12,0,12" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                <Border Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}" 
        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}" 
        BorderThickness="1" CornerRadius="8" Padding="20" Margin="0,0,0,16">
                    <StackPanel>
                        <!-- 1. 顶部：图标、标题和单选按钮 -->
                        <Grid Margin="0,0,0,20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ui:SymbolIcon Symbol="Storage24" Margin="0,0,12,0" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="虚拟硬盘" FontSize="16" VerticalAlignment="Center" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                                <RadioButton Content="新建磁盘" IsChecked="{Binding NewVmDiskMode, Converter={StaticResource EqualityConverter}, ConverterParameter=0}" Margin="0,0,16,0" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                                <RadioButton Content="现有磁盘" IsChecked="{Binding NewVmDiskMode, Converter={StaticResource EqualityConverter}, ConverterParameter=1}" Margin="0,0,16,0" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                                <RadioButton Content="稍后附加" IsChecked="{Binding NewVmDiskMode, Converter={StaticResource EqualityConverter}, ConverterParameter=2}" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                            </StackPanel>
                        </Grid>

                        <!-- 2. 分支内容：新建磁盘参数 (四列横向排版) -->
                        <StackPanel Visibility="{Binding NewVmDiskMode, Converter={StaticResource EqualityToVis}, ConverterParameter=0}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="20"/>
                                    <!-- 增大列间距 -->
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="20"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="20"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- 容量 -->
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="容量 (GB)" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                    <ComboBox IsEditable="True" Text="{Binding NewVmDiskSizeGb, UpdateSourceTrigger=PropertyChanged}" HorizontalAlignment="Stretch">
                                        <sys:String>32</sys:String>
                                        <sys:String>64</sys:String>
                                        <sys:String>128</sys:String>
                                        <sys:String>256</sys:String>
                                        <sys:String>512</sys:String>
                                        <sys:String>1024</sys:String>
                                    </ComboBox>
                                </StackPanel>

                                <!-- 磁盘类型 -->
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="磁盘类型" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                    <ComboBox SelectedValuePath="Tag" SelectedValue="{Binding NewVmDiskType}" HorizontalAlignment="Stretch">
                                        <ComboBoxItem Content="动态磁盘" Tag="Dynamic"/>
                                        <ComboBoxItem Content="固定磁盘" Tag="Fixed"/>
                                        <ComboBoxItem Content="差异磁盘" Tag="Differencing"/>
                                    </ComboBox>
                                </StackPanel>

                                <!-- 扇区格式 -->
                                <StackPanel Grid.Column="4">
                                    <TextBlock Text="扇区格式" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                    <ComboBox SelectedValuePath="Tag" SelectedValue="{Binding NewVmDiskSectorFormat}" HorizontalAlignment="Stretch">
                                        <ComboBoxItem Content="默认" Tag="Default"/>
                                        <ComboBoxItem Content="512n" Tag="512n"/>
                                        <ComboBoxItem Content="512e" Tag="512e"/>
                                        <ComboBoxItem Content="4Kn" Tag="4kn"/>
                                    </ComboBox>
                                </StackPanel>

                                <!-- 块大小 -->
                                <StackPanel Grid.Column="6">
                                    <TextBlock Text="块大小" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                    <ComboBox SelectedValuePath="Tag" SelectedValue="{Binding NewVmDiskBlockSize}" HorizontalAlignment="Stretch">
                                        <ComboBoxItem Content="默认" Tag="Default"/>
                                        <ComboBoxItem Content="1 MB" Tag="1048576"/>
                                        <ComboBoxItem Content="2 MB" Tag="2097152"/>
                                        <ComboBoxItem Content="4 MB" Tag="4194304"/>
                                        <ComboBoxItem Content="8 MB" Tag="8388608"/>
                                        <ComboBoxItem Content="16 MB" Tag="16777216"/>
                                        <ComboBoxItem Content="32 MB" Tag="33554432"/>
                                        <ComboBoxItem Content="64 MB" Tag="67108864"/>
                                        <ComboBoxItem Content="128 MB" Tag="134217728"/>
                                        <ComboBoxItem Content="256 MB" Tag="268435456"/>
                                    </ComboBox>
                                </StackPanel>
                            </Grid>

                            <!-- 差分磁盘的父路径 (仅在选择差分时显示，逻辑同步存储页) -->
                            <StackPanel Margin="0,16,0,0">
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding NewVmDiskType}" Value="Differencing">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>
                                <TextBlock Text="父磁盘路径" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ui:TextBox Text="{Binding NewVmParentDiskPath}" PlaceholderText="选择父 .vhdx 文件"/>
                                    <ui:Button Grid.Column="1" Content="浏览" Margin="8,0,0,0" Width="80" Command="{Binding BrowseParentDiskCommand}"/>
                                </Grid>
                            </StackPanel>
                        </StackPanel>

                        <!-- 3. 分支内容：现有磁盘路径 -->
                        <StackPanel Visibility="{Binding NewVmDiskMode, Converter={StaticResource EqualityToVis}, ConverterParameter=1}">
                            <Grid Margin="0,10,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ui:TextBox Text="{Binding NewVmExistingDiskPath}" PlaceholderText="选择 .vhdx 或 .avhdx 文件"/>
                                <ui:Button Grid.Column="1" Content="浏览" Margin="8,0,0,0" Width="80" Command="{Binding BrowseExistingDiskCommand}"/>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- 4. 安装镜像 (独立卡片) -->
                <Border Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}" 
        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}" 
        BorderThickness="1" CornerRadius="8" Padding="20" Margin="0,0,0,24">
                    <StackPanel>
                        <Grid Margin="0,0,0,16">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ui:SymbolIcon Symbol="FolderZip24" Margin="0,0,12,0" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                                <TextBlock Text="安装介质" FontSize="16" VerticalAlignment="Center" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                            </StackPanel>
                        </Grid>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <ui:TextBox Text="{Binding NewVmIsoPath}" PlaceholderText="选择操作系统安装 ISO 镜像 (可选)"/>
                            <ui:Button Grid.Column="1" Content="浏览" Margin="8,0,0,0" Width="80" Command="{Binding BrowseIsoImageCommand}"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- === 网络资源 === -->
                <TextBlock Text="网络资源" FontSize="16" FontWeight="Medium" Margin="0,0,0,12" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                <ui:CardControl Header="虚拟交换机" Margin="0,0,0,24" HorizontalContentAlignment="Stretch">
                    <ui:CardControl.Icon>
                        <ui:FontIcon Glyph="&#xE774;" FontSize="20" FontFamily="{DynamicResource SegoeFluentIcons}" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                    </ui:CardControl.Icon>
                    <ComboBox ItemsSource="{Binding AvailableSwitchNames}" SelectedItem="{Binding NewVmSelectedSwitch}"/>
                </ui:CardControl>

                <!-- 3. 操作栏（已移动至 ScrollViewer 内部，不再悬浮） -->
                <Border Background="Transparent" BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0" Padding="0,24,0,0">
                    <Grid>
                        <CheckBox Content="创建后启动" IsChecked="{Binding StartVmAfterCreation}" VerticalAlignment="Center"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <ui:Button Content="取消" Appearance="Secondary" Width="100" Margin="0,0,12,0" Command="{Binding CancelCreateCommand}"/>
                            <ui:Button Content="创建虚拟机" Appearance="Primary" Width="150" Icon="{ui:SymbolIcon Symbol=Add24}" Command="{Binding ConfirmCreateCommand}"/>
                        </StackPanel>
                    </Grid>
                </Border>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>