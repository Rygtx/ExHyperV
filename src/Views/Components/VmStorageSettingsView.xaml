<UserControl x:Class="ExHyperV.Views.Components.VmStorageSettingsView"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:vm="clr-namespace:ExHyperV.ViewModels"
                 xmlns:properties="clr-namespace:ExHyperV.Properties"
                 xmlns:converters="clr-namespace:ExHyperV.Converters"
                 mc:Ignorable="d" d:DesignHeight="800" d:DesignWidth="1000"
                 d:DataContext="{d:DesignInstance vm:VirtualMachinesPageViewModel}">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:EqualityConverter x:Key="EqualityConverter" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- 标题栏 -->
            <RowDefinition Height="Auto"/>
            <!-- 进度条 -->
            <RowDefinition Height="*"/>
            <!-- 列表内容 -->
        </Grid.RowDefinitions>

        <!-- 1. 标题栏 -->
        <Grid Grid.Row="0" Margin="24,16,24,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="{x:Static properties:Resources.Storage_Settings}" FontSize="20"  Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <ui:Button  Content="添加" Icon="{ui:SymbolIcon Symbol=Add24,FontSize=20}" 
               ToolTip="{x:Static properties:Resources.Storage_AddStorage}"
               Appearance="Primary" 
               Margin="0,0,12,0"
               Command="{Binding GoToAddStorageCommand}"/>

                <ui:Button Appearance="Transparent" Padding="8" Command="{Binding GoBackToDashboardCommand}">
                    <ui:SymbolIcon Symbol="ArrowLeft24" FontSize="18"/>
                </ui:Button>
            </StackPanel>
        </Grid>

        <!-- 2. 加载进度条 -->
        <ProgressBar Grid.Row="1" IsIndeterminate="True" VerticalAlignment="Top" Height="2" Margin="0,-2,0,0"
                         Visibility="{Binding IsLoadingSettings, Converter={StaticResource BooleanToVisibilityConverter}}"/>

        <!-- 3. 内容区域 -->
        <ScrollViewer Grid.Row="2" Padding="24,0,24,24" VerticalScrollBarVisibility="Auto">
            <Grid>

                <!-- 存储项列表 -->
                <ItemsControl ItemsSource="{Binding SelectedVm.StorageItems}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <ui:CardExpander Margin="0,0,0,8" IsExpanded="True" ContentPadding="0" Padding="12,8">
                                <ui:CardExpander.Header>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <ui:FontIcon Grid.Column="0" Glyph="{Binding Icon}" FontFamily="{StaticResource SegoeFluentIcons}" FontSize="20" VerticalAlignment="Center"/>

                                        <!-- 修改2：文件名和容量放在同一行 -->
                                        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="16,0,0,0">
                                            <TextBlock Text="{Binding DisplayName}" FontSize="15" FontWeight="Medium" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

                                            <TextBlock FontSize="12" Opacity="0.6" Margin="12,2,0,0" VerticalAlignment="Bottom">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                                        <Setter Property="Text" Value="{Binding SizeDisplay}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding PathOrDiskNumber}" Value="{x:Null}">
                                                                <Setter Property="Text" Value="{x:Static properties:Resources.Common_Empty}"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding PathOrDiskNumber}" Value="">
                                                                <Setter Property="Text" Value="{x:Static properties:Resources.Common_Empty}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>

                                        <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="0,0,12,0">
                                            <!-- 新增：打开文件夹按钮 -->
                                            <ui:Button Icon="{ui:SymbolIcon Symbol=Share24, FontSize=18}" 
               ToolTip="打开所在文件夹"
               Appearance="Secondary" 
               Margin="0,0,8,0"
               Command="{Binding DataContext.OpenFolderCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
               CommandParameter="{Binding PathOrDiskNumber}">
                                                <ui:Button.Style>
                                                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <!-- 如果路径为空或 null，则不显示该按钮 -->
                                                            <DataTrigger Binding="{Binding PathOrDiskNumber}" Value="">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding PathOrDiskNumber}" Value="{x:Null}">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ui:Button.Style>
                                            </ui:Button>

                                            <ui:Button Icon="{ui:SymbolIcon Symbol=Edit24, FontSize=18}" 
           ToolTip="{x:Static properties:Resources.Common_Modify}"
           Appearance="Secondary" 
           Margin="0,0,8,0"
           Command="{Binding DataContext.EditStoragePathCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
           CommandParameter="{Binding}">
                                                <ui:Button.Style>
                                                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <!-- 1. 当类型为 DvdDrive (ISO) 时显示 -->
                                                            <DataTrigger Binding="{Binding DriveType}" Value="DvdDrive">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>

                                                            <!-- 2. 当类型为 HardDisk (注意不是 HardDrive) 且不是物理磁盘时显示 -->
                                                            <MultiDataTrigger>
                                                                <MultiDataTrigger.Conditions>
                                                                    <Condition Binding="{Binding DriveType}" Value="HardDisk"/>
                                                                    <Condition Binding="{Binding DiskType}" Value="Virtual"/>
                                                                </MultiDataTrigger.Conditions>
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </MultiDataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ui:Button.Style>
                                            </ui:Button>
                                            <ui:Button Icon="{ui:SymbolIcon Symbol=Delete24,FontSize=18}" 
                           Appearance="Secondary"
                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                           Command="{Binding DataContext.RemoveStorageItemCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                           CommandParameter="{Binding}"/>
                                        </StackPanel>
                                    </Grid>
                                </ui:CardExpander.Header>

                                <Border Padding="20,16" Background="{ui:ThemeResource ControlFillColorSecondaryBrush}" BorderThickness="0,1,0,0" BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="{x:Static properties:Resources.Common_Type}" Margin="0,0,0,10" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SourceTypeDisplayName}" Margin="0,0,0,10" FontWeight="Medium"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="{x:Static properties:Resources.Storage_Slot}" Margin="0,0,0,10" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                        <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Margin="0,0,0,10">
                                            <TextBlock Text="{Binding ControllerType}" FontWeight="Medium"/>
                                            <TextBlock Text=" 控制器 " FontWeight="Medium"/>
                                            <TextBlock Text="{Binding ControllerNumber}" FontWeight="Medium"/>
                                            <TextBlock Text=" - 位置 " FontWeight="Medium"/>
                                            <TextBlock Text="{Binding ControllerLocation}" FontWeight="Medium"/>
                                        </StackPanel>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="{x:Static properties:Resources.Common_Path}" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding PathOrDiskNumber}" TextWrapping="Wrap" FontWeight="Medium" Opacity="0.9">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding PathOrDiskNumber}" Value="">
                                                            <Setter Property="Text" Value="{x:Static properties:Resources.Common_Empty}"/>
                                                            <Setter Property="Opacity" Value="0.5"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </ui:CardExpander>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </ScrollViewer>
    </Grid>
</UserControl>